# 1010 TIL

### 1. N+1 문제 
- 정의 : 객체를 대상으로 수행되는 쿼리가 해당 객체의 연관관계도 조회하면서 N번의 추가적인 쿼리가 발생
- 원인 : 관계형 데이터베이스와 객체지향 언어간의 차이로 RDB는 연관관계를 SELECT 쿼리를 통해서만 조회할 수 있음
 - 해결방법
    - ___Fetch Join___ : JPQL로 쿼리를 작성

- 변경 전
```Java
    Cart cart = cartRepository.findById(cartId).orElseThrow(()->new IllegalArgumentException("존재하지 않는 메뉴이거나 이미 삭제되었습니다.")); 

    if (!cart.getCustomer().getUser().getId().equals(user.getId())) { throw new AccessDeniedException("올바른 접근이 아닙니다"); }
 ```
    
- 변경 후
```Java
	Cart cart = cartRepository.findByIdWithCustomerAndUser(cartId).orElseThrow(()->new IllegalArgumentException("존재하지 않는 메뉴이거나 이미 삭제되었습니다."));
    
    @Query("SELECT c FROM Cart c JOIN FETCH c.customer cu JOIN FETCH cu.user u WHERE c.id = :cartId")
	Optional<Cart> findByIdWithCustomerAndUser(@Param("cartId") UUID cartId);

``` 

>참고

[[JPA] N+1 문제 원인 및 해결방법](https://s-y-130.tistory.com/184)
[JPA N+1 문제와 해결법 총정리](https://velog.io/@xogml951/JPA-N1-%EB%AC%B8%EC%A0%9C-%ED%95%B4%EA%B2%B0-%EC%B4%9D%EC%A0%95%EB%A6%AC)
