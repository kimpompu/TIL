# 251112 TIL

## 공통모듈 모노 레포지토리에서 QueryDsl 적용방법

### 개별 서비스에 Qclass 파일이 생성되지않음 문제 발생
- 개별 서비스 프로젝트 루트에 Qclass 파일이 생성되지않음

### 해결

1. common 에 의존성 추가
```Gradle
    // QueryDSL Dependencies
    implementation 'com.querydsl:querydsl-jpa:5.0.0:jakarta' // JPA 사용 시
    annotationProcessor 'com.querydsl:querydsl-apt:5.0.0:jakarta' // Annotation Processor
    annotationProcessor 'jakarta.persistence:jakarta.persistence-api' // JPA API
    annotationProcessor 'jakarta.annotation:jakarta.annotation-api' // Annotation API
```

2. `Annotation Processor` 설정
```
    sourceSets {
        main {
            java {
                srcDirs = ['src/main/java', 'build/generated/sources/annotationProcessor/java/main']
            }
        }
    }    
```
- QClass가 생성되는 디렉토리(build/generated/sources/annotationProcessor/java/main)를 소스 경로로 지정

3. Gradle clean 후 재빌드


## docker-compose로 postgreSQL 단일 DB 사용, 서비스별 스키마 분리

### 설정
1. \`init-db`\`init-schemas.sh` 생성
```sh
    set -e

    # 환경 변수에서 기본 DB 정보 로드
    DB_NAME="$POSTGRES_DB"
    DB_USER="$POSTGRES_USER"

    echo "Initializing PostgreSQL schemas for QuickBaesong MSA..."

    # PostgreSQL에 접속하여 스키마 생성 및 권한 부여
    # ${DB_NAME} (quickbaesong_main) 데이터베이스에 접속하여 SQL 실행
    psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "$DB_NAME" <<-EOSQL

        -- Service용 스키마 생성 및 권한 부여
        CREATE SCHEMA IF NOT EXISTS order_schema AUTHORIZATION $DB_USER;
        CREATE SCHEMA IF NOT EXISTS user_schema AUTHORIZATION $DB_USER;
        CREATE SCHEMA IF NOT EXISTS item_schema AUTHORIZATION $DB_USER;
        CREATE SCHEMA IF NOT EXISTS company_schema AUTHORIZATION $DB_USER;
        CREATE SCHEMA IF NOT EXISTS hub_schema AUTHORIZATION $DB_USER;
        CREATE SCHEMA IF NOT EXISTS notification_schema AUTHORIZATION $DB_USER;
        CREATE SCHEMA IF NOT EXISTS delivery_schema AUTHORIZATION $DB_USER;

        -- 생성된 스키마에 대한 권한을 DB 사용자에게 부여
        GRANT ALL ON SCHEMA order_schema TO $DB_USER;
        GRANT ALL ON SCHEMA user_schema TO $DB_USER;
        GRANT ALL ON SCHEMA item_schema TO $DB_USER;
        GRANT ALL ON SCHEMA company_schema TO $DB_USER;
        GRANT ALL ON SCHEMA hub_schema TO $DB_USER;
        GRANT ALL ON SCHEMA notification_schema TO $DB_USER;
        GRANT ALL ON SCHEMA delivery_schema TO $DB_USER;

        SELECT 'All schemas created and permissions granted successfully' AS status;

    EOSQL

    echo "Initialization complete."
```

2. `docker-compose.yml` 작성
```yml
    version: '3.8'

    services:
    postgres_db:
        image: postgres:16
        container_name: msa-postgres-db
        restart: always
        environment:
        POSTGRES_ROOT_PASSWORD: ${POSTGRES_ROOT_PASSWORD}
        POSTGRES_DB: ${POSTGRES_DB_NAME}
        POSTGRES_USER: ${POSTGRES_APP_USER}
        POSTGRES_PASSWORD: ${POSTGRES_APP_PASSWORD}
        ports:
        - "5432:5432"
        volumes:
        - postgres-data:/var/lib/postgresql/data
        - ./init-db/init-schemas.sh:/docker-entrypoint-initdb.d/init-schemas.sh
        healthcheck:
        test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_APP_USER} -d ${POSTGRES_DB_NAME}"]
        interval: 10s
        timeout: 5s
        retries: 5

    volumes:
    postgres-data:
```

3. 환경변수로 값 부여
```-DPOSTGRES_APP_USER=username -DPOSTGRES_APP_PASSWORD=password -DPOSTGRES_DB_NAME=dbname```

4. docker-compose up -d
5. 서비스별 application.yml 작성

```yml
    server:
    port: 8086

    spring:
    application:
        name: order-service
    config:
        import:
        - optional:file:../../.env
        - optional:file:./.env

    # --- Docker DB 연결 설정 (PostgreSQL) ---
    datasource:
        url: jdbc:postgresql://localhost:5432/${POSTGRES_DB_NAME}
        username: ${POSTGRES_APP_USER}
        password: ${POSTGRES_APP_PASSWORD} 
        driver-class-name: org.postgresql.Driver

    # --- JPA/Hibernate 설정 ---
    jpa:
        hibernate:
        ddl-auto: update
        properties:
            # 이 서비스가 사용할 스키마 지정
            hibernate.default_schema: order_schema
            hbm2ddl.auto-create-schemas: true
            hibernate.format_sql: true
            hibernate.highlight_sql: true
        show-sql: true

    eureka:
    client:
        service-url:
        defaultZone: http://localhost:19090/eureka/
```

6. 테이블에 schema 사용 표시
```Java
@Table(name = "p_order", schema = "order_schema")
```


### 실패
1. 환경변수 프로필이 로컬로 되어있어 application-local.yml과 충돌
2. 서비스에서 루트 .env 불러오지못함


### 인텔리제이에서 DB 스키마 안보일 때
-  `[Properties]` - `[Schemas]` - `[ALl schemas]` 선택 후 `Apply` -> `OK`