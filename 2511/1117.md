# 251117 TIL

## CORS(Cross-Origin Resource Sharing)
- 웹 브라우저가 다른 출처(origin) 의 서버로 요청할 때 보안상의 이유로 기본적으로 차단하는 정책(`Same-Origin Policy`)을 예외적으로 허용하기 위해 만들어진 표준 메커니즘

### 출처(Origin)
- 프로토콜 + 도메인 + 포트
    ex) https://example.com:443

### 서버 개발자가 반드시 알아야 할 핵심 내용
| 구분                                | 설명                                                         |
| --------------------------------- | ---------------------------------------------------------- |
| **Same-Origin Policy**            | 브라우저는 기본적으로 다른 출처로의 요청을 차단한다. API 호출도 예외 아님.               |
| **Preflight 요청**                  | `OPTIONS` 메서드로 사전 요청을 보냄. 서버가 CORS 정책을 응답해야 실제 요청 진행 가능.   |
| **Access-Control-Allow-Origin**   | 가장 중요한 헤더. 어떤 출처를 허용할지 지정.                                 |
| **Credentials 처리**                | 쿠키·헤더 포함 요청 시 `allowCredentials(true)` 필수 + `*` 와 함께 사용 불가 |
| **서버에서 설정해야 브라우저가 허용**            | 문제는 프런트가 아니라 서버 설정이다.                                      |
| **전역 설정의 위험성**                    | 모든 origin 허용은 개발환경에서는 OK, 운영에서는 보안 취약성 초래.                 |
| **Spring Security 사용 시 추가 설정 필요** | Security는 필터 체인 초기에 CORS를 처리하므로 별도 설정 필수.                  |
| **필터 기반과 WebMvc 기반 차이**           | Spring Security를 사용하는 경우 WebMvc 설정만으로 부족할 수 있음.            |


### Spring Boot CORS 설정 방식

0. config 설정
```Java
@Configuration
@EnableWebSecurity
public class SecurityConfig {

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {

        http
            .csrf().disable()
            .cors() // 반드시 활성화
            .and()
            .authorizeHttpRequests()
            .anyRequest().permitAll();

        return http.build();
    }

    @Bean
    public CorsConfigurationSource corsConfigurationSource() {
        CorsConfiguration config = new CorsConfiguration();
        config.addAllowedOrigin("https://my-frontend.com");
        config.addAllowedMethod("*");
        config.addAllowedHeader("*");
        config.setAllowCredentials(true);

        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", config);
        return source;
    }
}
```


1. 전역 CORS 설정(`WebMvcConfigurer`)
    ```Java
    @Configuration
    public class WebConfig implements WebMvcConfigurer {

        @Override
        public void addCorsMappings(CorsRegistry registry) {
            registry.addMapping("/api/**")
                    .allowedOrigins("https://my-frontend.com")
                    .allowedMethods("GET", "POST", "PUT", "DELETE")
                    .allowedHeaders("*")
                    .allowCredentials(true)
                    .maxAge(3600);
        }
    }
    ```

2. 컨트롤러에 개별 CORS 설정

    ```Java
    @RestController
    @RequestMapping("/api")
    @CrossOrigin(origins = "https://my-frontend.com")
    public class UserController {

        @GetMapping("/users")
        public String users() {
            return "OK";
        }
    }
    ```

### CORS 주요 헤더
| 헤더명                                | 설명                                           |
| ---------------------------------- | -------------------------------------------- |
| `Access-Control-Allow-Origin`      | 허용할 origin 지정 (`*`은 전체 허용, 단 Credentials 불가) |
| `Access-Control-Allow-Methods`     | 허용할 HTTP 메서드                                 |
| `Access-Control-Allow-Headers`     | 실제 요청에서 허용할 헤더 목록                            |
| `Access-Control-Allow-Credentials` | 쿠키·인증정보 포함 요청 허용 여부                          |
| `Access-Control-Max-Age`           | Preflight 캐시 시간                              |
| `Access-Control-Request-Headers`   | 브라우저가 Preflight에서 요청에 사용할 헤더 전달              |
| `Access-Control-Request-Method`    | Preflight에서 실제 요청 메서드 전달                     |


### 흔히 마주치는 CORS 에러 & 원인
| 에러 메시지                                                                       | 원인                                               |
| ---------------------------------------------------------------------------- | ------------------------------------------------ |
| `No 'Access-Control-Allow-Origin' header is present`                         | 서버에서 origin 허용을 안 함                              |
| `The value of the 'Access-Control-Allow-Origin' header ... must not be '*''` | Credentials(true)와 `*`를 함께 사용함                   |
| `CORS policy: Method not allowed`                                            | 서버에서 해당 HTTP 메서드 미허용                             |
| `CORS preflight channel did not succeed`                                     | OPTIONS(Preflight) 요청이 서버에서 차단됨 (주로 security 문제) |
