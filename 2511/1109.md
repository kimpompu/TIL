# 251109 TIL

## 영속성 컨텍스트(EntityManager)
- 엔티티 객체를 관리하는 메모리 공간
- JPA가 자동으로 상태를 추적하고 SQL을 실행

### 1차 캐시
- 영속성 컨텍스트가 관리하는 엔티티의 메모리 사본


| 메서드         | 영속성 컨텍스트 | 1차 캐시            | DB 실행                                            |
| ----------- | -------- | ---------------- | ------------------------------------------------ |
| `persist()` | 신규 등록    | 캐시에 저장           | commit 시 insert                                  |
| `merge()`   | 없는 객체 병합 | 새로 생성된 관리 객체에 반영 | commit 시 update (DB row 존재하면 update, 없으면 insert) |
| `save()`    | 상황 따라 다름 | persist/merge 동작 | commit 시 insert/update                           |

| 동작                              | Aggregate Root         | Child (Cascade)                    | DB 반영           | SoftDelete |
| ------------------------------- | ---------------------- | ---------------------------------- | --------------- | ---------- |
| `persist(order)`                | 영속화됨                   | `CascadeType.PERSIST` → 함께 영속화     | INSERT          | -          |
| `merge(order)`                  | Detached → Managed     | 함께 merge                           | UPDATE / INSERT | -          |
| `save(order)` (Spring Data JPA) | 내부적으로 persist/merge 결정 | 같이 처리                              | INSERT/UPDATE   | -          |
| SoftDelete `order.softDelete()` | `deleted=true`         | 자식 `orderItems`도 `deleted=true` 전파 | UPDATE          | ✅          |

```pgsql

[Client] ---> OrderService.createOrder(orderDto)
        |
        v
  [Order Aggregate Root] 
  order.addItem(OrderItem1)
  order.addItem(OrderItem2)
        |
        v
  orderRepository.save(order)
        |
        |-- persist() 호출
        |     - Order 상태: NEW → Managed
        |     - Cascade.PERSIST → OrderItem1, OrderItem2도 Managed
        |
        |-- DB INSERT: order, order_item 테이블
        
```